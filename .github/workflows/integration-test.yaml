---
name: integration-test
on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CLIVM_LOG_LEVEL: debug
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v3.2.0
      with:
        go-version: '1.18.3'
        cache: true

    - run: go install ./cmd/clivm
    - run: echo "${XDG_DATA_HOME:-$HOME/.local/share}/clivm/bin" >> "$GITHUB_PATH"
    - run: echo "CLIVM_GLOBAL_CONFIG=$PWD/tests/clivm-global.yaml:$PWD/tests/clivm-global-2.yaml" >> "$GITHUB_ENV"
    - run: echo "standard,kubernetes-sigs/kind" | clivm g -f -
    - run: echo "x-motemen/ghq" | clivm g -f -
    - run: echo "local,clivm/clivm-installer" | clivm -c tests/clivm-global.yaml g -f -
    - run: clivm g x-motemen/ghq clivm/clivm-installer
    - run: echo cli/cli | clivm g -f - x-motemen/ghq clivm/clivm-installer

    - run: clivm list
    - run: clivm i -l -a
      working-directory: tests
    - run: cmdx -v
      working-directory: tests
    - run: clivm i --test
      working-directory: tests
    - run: clivm which golangci-lint
      working-directory: tests
    - run: clivm which go
    - run: golangci-lint version
    - run: kind version
      working-directory: tests
    - run: kind version
    - run: restic version
    - run: migrate -version
    - run: ghq -version
    - run: gh version
    - run: tfenv --version
    - run: clivm -c tests/clivm-global.yaml g local,kubernetes-sigs/kustomize
    - run: btop -v
    - run: btop -v
      env:
        CLIVM_EXPERIMENTAL_X_SYS_EXEC: "true"
    - run: wire --help
    - run: gox --help
    - run: bats -v
    - run: github-compare -v
    - run: terrafmt version

    - name: output bash completion
      run: clivm completion bash
    - name: output zsh completion
      run: clivm completion zsh

    - run: clivm g -i suzuki-shunsuke/tfcmt
      working-directory: tests
    - run: git diff clivm.yaml
      working-directory: tests

    - name: "Test generate-registry"
      run: clivm gr cli/cli
    - name: "Test generate-registry (rust)"
      run: clivm gr XAMPPRocky/tokei

    - name: "test version_source: github_tag"
      run: clivm -c clivm-global.yaml g local,mitchellh/gox
      working-directory: tests

    # Test if global configuration files are read in `clivm list` and `clivm g`
    - run: clivm g suzuki-shunsuke/cmdx
      working-directory: /tmp
    - run: clivm list
      working-directory: /tmp

    - run: clivm-installer -v v0.8.1 -i /tmp/aqua

  build-windows:
    runs-on: windows-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CLIVM_LOG_LEVEL: debug
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v3.2.0
      with:
        go-version: '1.18.3'
        cache: true

    - run: go install ./cmd/clivm
    - run: echo "$HOME/AppData/Local/clivm/bin" >> "$GITHUB_PATH"
    - run: echo "CLIVM_GLOBAL_CONFIG=$PWD/tests/clivm-global.yaml:$PWD/tests/clivm-global-2.yaml" >> "$GITHUB_ENV"
    - run: echo "standard,kubernetes-sigs/kind" | clivm g -f -
    - run: echo "x-motemen/ghq" | clivm g -f -
    - run: clivm g x-motemen/ghq clivm/clivm-installer
    - run: echo cli/cli | clivm g -f - x-motemen/ghq clivm/clivm-installer

    - run: clivm list
    - run: clivm i -l -a
      working-directory: tests
    - run: cmdx -v
      working-directory: tests
    - run: clivm i --test
      working-directory: tests
    - run: clivm which golangci-lint
      working-directory: tests
    - run: clivm which go
    - run: golangci-lint version
    - run: kind version
      working-directory: tests
    - run: kind version
    - run: restic version
    - run: migrate -version
    - run: ghq -version
    - run: gh version
    - run: clivm -c tests/clivm-global.yaml g local,kubernetes-sigs/kustomize
    - run: wire --help
    - run: gox --help
    - run: github-compare -v
    - run: terrafmt version

    - run: clivm g -i suzuki-shunsuke/tfcmt
      working-directory: tests
    - run: git diff clivm.yaml
      working-directory: tests

    - name: "Test generate-registry"
      run: clivm gr cli/cli
    - name: "Test generate-registry (rust)"
      run: clivm gr XAMPPRocky/tokei

    - name: "test version_source: github_tag"
      run: clivm -c clivm-global.yaml g local,mitchellh/gox
      working-directory: tests

    # Test if global configuration files are read in `clivm list` and `clivm g`
    - run: clivm g suzuki-shunsuke/cmdx
      working-directory: ${{ env.HOME }}
    - run: clivm list
      working-directory: ${{ env.HOME }}

  build-windows-pwsh:
    runs-on: windows-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CLIVM_LOG_LEVEL: debug
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v3.2.0
      with:
        go-version: '1.18.3'
        cache: true

    - run: go install ./cmd/clivm
    - run: echo "$HOME\AppData\Local\clivm\bat" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - run: echo "CLIVM_GLOBAL_CONFIG=$PWD\tests\clivm-global.yaml;$PWD\tests\clivm-global-2.yaml" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    - run: echo "standard,kubernetes-sigs/kind" | clivm g -f -
    - run: echo "x-motemen/ghq" | clivm g -f -
    - run: clivm g x-motemen/ghq clivm/clivm-installer
    - run: echo cli/cli | clivm g -f - x-motemen/ghq clivm/clivm-installer

    - run: clivm list
    - run: clivm i -l -a
      working-directory: tests
    - run: cmdx -v
      working-directory: tests
    - run: clivm i --test
      working-directory: tests
    - run: clivm which golangci-lint
      working-directory: tests
    - run: clivm which go
    - run: golangci-lint version
    - run: kind version
      working-directory: tests
    - run: kind version
    - run: restic version
    - run: migrate -version
    - run: ghq -version
    - run: gh version
    - run: clivm -c tests/clivm-global.yaml g local,kubernetes-sigs/kustomize
    - run: wire --help
    - run: gox --help
    - run: github-compare -v
    - run: terrafmt version

    - run: clivm g -i suzuki-shunsuke/tfcmt
      working-directory: tests
    - run: git diff clivm.yaml
      working-directory: tests

    - name: "Test generate-registry"
      run: clivm gr cli/cli
    - name: "Test generate-registry (rust)"
      run: clivm gr XAMPPRocky/tokei

    - name: "test version_source: github_tag"
      run: clivm -c clivm-global.yaml g local,mitchellh/gox
      working-directory: tests

    # Test if global configuration files are read in `clivm list` and `clivm g`
    - run: clivm g suzuki-shunsuke/cmdx
      working-directory: ${{ env.HOME }}
    - run: clivm list
      working-directory: ${{ env.HOME }}
